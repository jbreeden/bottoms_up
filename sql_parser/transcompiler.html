<html>
  <head>
    <script src="underscore.js"></script>
    <script src="jquery.js"></script>
    <script src="trace.js"></script>
    <script src="lexer.js"></script>
    <script src="parser.js"></script>
    <script src="lex-sql.js"></script>
    <script src="parse-sql.js"></script>
    <style>
.test {
  margin-bottom: 10px;
}

.test, .test textarea {
  font-size: 10pt;
}

.test .column {
  display: inline-block;
  padding: auto 0 auto 0;
}

.test textarea {
  display: inline-block;
}
    </style>
  </head>
  <body>
    <script>

parser = new SQLParser();
parser.setTraceLevel(Trace.error);

function test(title, sql) {
  test.number = test.number || 0;
  $('body').append($(
    "<div id='test" + test.number + "' class='test'>" +
      "<h1>" + title + "</h1>" +
      "<div class='column'>SQL<br/><textarea class='sql-input' rows='20' cols='40'>" +
        sql +
      "</textarea></div>" +
      "<div class='column'>AST<br/><textarea class='ast' rows='20' cols='40'>" +
      "</textarea></div>" +
      "<div class='column'>Query<br/><textarea class='query' rows='20' cols='40'>" +
      "</textarea></div>" +
      "<div class='column'>SPL<br/><textarea class='spl' rows='20' cols='40'>" +
      "</textarea></div>" +
      "<div><button class='refresh' onclick='refresh(" + test.number + ")'>Refresh</button></div>" +
    "</div>"
  ).get(0));
  refresh(test.number);
  test.number++;
}

function refresh (testNumber) {
  var $test = $("#test" + testNumber)
  try {
    parser.transcompile($test.find(".sql-input").val(), function (error, ast, query) {
      if (error) {
        onError(error);
      } else {
        $test.find('.ast').val(JSON.stringify(ast, null, 2));
        $test.find('.query').val(JSON.stringify(query, null, 2));
        $test.find('.spl').val(query.toSPL());
      }
    });
  } catch (ex) {
    onError(ex);
  }

  function onError(error) {
    $test.find('.ast').val(error);
    $test.find('.query').val('');
    $test.find('.spl').val('');
  };
}

test('Select *',
'select * \n\
from git');

test('Select Distinct',
'select distinct * \n\
from git');

test('Select Aggregate',
'select max(sha) \n\
from git');

test('Select Aggregate Aliased',
'select max(sha) as "Max Sha" \n\
from git');

test('Select Fields',
'select author_name, author_date \n\
from git');

test('Filter',
'select sha, author_date \n\
from git\n\
where author_name = \'Brian Krueger\'');

test('Filter - Not Equal Conversion',
'select sha, author_date \n\
from git\n\
where author_name <> \'Brian Krueger\'');

test('Filter - Not Greater Conversion',
'select num \n\
from my_index\n\
where num !> 5');

test('Filter - Not Less Conversion',
'select num \n\
from my_index\n\
where num !< 5');

test('Alias', 'select this as that, other from git where something < 5');

test('Select * and Alias',
'select col as my_col, *\n\
from git');

test('Comments',
'-- All Fields\n\
select * \n\
--From the git index\n\
from git \n\
--Where some field < 5\n\
where something < 5');

test('Limit',
'select *\n\
from default\n\
limit 100');

test('Order By',
'select *\n\
from default\n\
order by name');

test('Group By (No Aggregates yields uniq even without DISTINCT clause)',
'select first_name, last_name as "Last Name" \n\
from index\n\
where first_name = \'steve\' \n\
group by first_name, "Last Name" \n\
having last_name like \'%Burg%\'\n\
order by last_name\n\
limit 100');

test('Group By Handles Projection & Aggregate Aliases',
'select distinct first_name, last_name as "Last Name", max(age)\n\
from index\n\
where first_name = \'steve\' \n\
group by first_name, "Last Name" \n\
having last_name like \'%Burg%\'\n\
order by last_name\n\
limit 100');

test('Group By w/ Aggregates',
'select distinct first_name, last_name as "Last Name", max(age)\n\
from index\n\
where first_name = \'steve\' \n\
group by first_name, "Last Name" \n\
having last_name like \'%Burg%\'\n\
order by last_name\n\
limit 100');

test('Group By w/ Aggregates Aliased',
'select distinct first_name, last_name as "Last Name", max(age) as "Max Age"\n\
from index\n\
where first_name = \'steve\' \n\
group by first_name, "Last Name" \n\
having last_name like \'%Burg%\'\n\
order by last_name\n\
limit 100');

test('Cannot Group by *',
'select last_name as "Last Name" \n\
from index\n\
where first_name = \'steve\' \n\
group by * \n\
having "Last Name" like \'%Burg%\'\n\
order by last_name\n\
limit 100');

    </script>
  </body>
</html>
